---
title: "L2-map species"
output: html_document
---

Inputs:
1) image (single plant[category]) with geotags
Outcomes:
a) Geomap
b) Identify
c) *Details
d) *Storage
e) 

1. Image -> species name
  # https://my.plantnet.org/usage
  # https://github.com/BiologicalRecordsCentre/plantnet
2. species name -> gbif data
3. Image -> GPS data
4. Map image + name + GPS

1) User image upload (local or URL provided)
2) Request_ID is autogenerated, associated by image_name & date (system event date), exif data extracted
  - `JSON` with +Request_ID, +image_url address, +exif_data
3) Exif data (metadata) is checked for exif_data$Geocoordinates
  - IF not found, END
4) Plant recognition API image upload, and species_name returned, added to Request_ID `JSON`
  - Add +PN_REST_response to `JSON`, incl PN_REST_response$species_name (rankings)
  - User prompt at warning, poor image recognition score
    - If not desired to continue, END
5) Use PN_REST_response$species_name to get GBIF information, add to `JSON`
  - Add +GBIF_REST_response to `JSON`, incl GBIF_REST_response$species_name (rankings)
6) Get Map by geocoordinates (satellite view), add to `JSON`
7) Save `JSON` to local storage


# Image GPS & timestamp extract [done]
GPS_extract.Rmd
```{r Data Input}
source(file = "Scripts/DataInput.R")
DIR = "/home/agar2/Documents/1Projects/Local-species-catalogue/"
imageURL = paste0(DIR, "Pictures/thistle-5150476_960_720.jpg")
imagedata <- getImagedata(imageURL)


# Image Testing source dataset=
#   <https://www.gbif.org/dataset/7a3679ef-5582-4aaa-81f0-8c2545cafc81>
  
# Testing functions

## Hosted, ERROR: doesn't contain 'GPS'
pic.ext_1 <- 'https://cdn.pixabay.com/photo/2020/05/09/17/04/thistle-5150476_960_720.jpg'
#getImagedata(pic.ext_1)

## Hosted, Working (using GBIF source, use 'Identifier' link)
pic.ext_2 <- "https://bs.plantnet.org/image/o/090f920a7c32b350e135fe1eec1b2fb4e0d81497"
getImagedata(pic.ext_2)

## Local, ERROR: doesn't contain 'filename' in metadata 
pic.int_1 <- "/home/agar2/Documents/1Projects/Local-species-catalogue/Pictures/fab3b610b796778928299f535f661984e5eebd7c.jpeg"
getImagedata(pic.int_1)
```

STORAGE
 - Postgres (lo) vs MongoDB (base64)

# Image recognition API via PlantNet [done]
API-plantnet.Rmd
plantnetkey.txt

```{r PlantNet Species Recognition API}
source(file = "Scripts/ImageRecognition.R")
key <- as.character(read.table("./plantnetkey.txt"))
imageURL <- 'https://bs.plantnet.org/image/o/090f920a7c32b350e135fe1eec1b2fb4e0d81497'
species1 <- getSpecies(key, imageURL, organ = "flower")
```
TODO
 - Multiple image submission for identification API

# Species data via GBIF API [incomp]
GBIF data.Rmd
```{r GBIF Data API}
source("Scripts/speciesData.R")
speciesInfo(species1[1])
```

# Map Image GPS [done]
GPS_map.Rmd
```{r map}

# Map with gps coordinates
gps1 <- data.frame(species = "arabidopsis", lon = -79.26887718018865, lat = 44.2486202976625)   # randomly taken from Google maps
gps2 <- data.frame(species = "arabidopsis", lon = -79.26818923287712, lat = 44.2487061833985)   # randomly taken from Google maps
gps3 <- data.frame(species = "dinosaur", lon = -79.26616416507017, lat = 44.24929218118515)   # randomly taken from Google maps

gps <- rbind(gps1, gps2, gps3)
map_plot
```
TODO
 - Observation image tile on map
 - Review GeoServer for hosting/interoperability of geodata

# Shiny time-series
```{r Shinyapp}

```


